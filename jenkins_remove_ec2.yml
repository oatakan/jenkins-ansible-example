- name: remove Jenkins instances
  hosts: all
  gather_facts: false
  connection: local
  vars:
    ansible_ssh_password: ''
  become: no
  vars_files:
    - node-config/nodes-ec2.yml

  pre_tasks:
    - name: get record for router DNS entry
      community.aws.route53:
        command: get
        zone: "{{ hosted_zone_domain_name }}"
        record: "{{ subdomain | default(ec2_instances.instances[0].tags.role | lower) | default('jenkins') }}.{{ ec2_name_prefix | lower }}.{{ hosted_zone_domain_name }}"
        type: A
      register: routerelbrec
      when: hosted_zone_domain_name is defined and ec2_name_prefix is defined
      delegate_to: localhost

    - name: delete DNS entry if it doesn't exist
      community.aws.route53:
        state: absent
        zone: "{{ hosted_zone_domain_name }}"
        record: "{{ subdomain | default(ec2_instances.instances[0].tags.role | lower) | default('jenkins') }}.{{ ec2_name_prefix | lower }}.{{ hosted_zone_domain_name }}"
        type: A
        value: "{{ routerelbrec.set.value }}"
        alias: True
        alias_hosted_zone_id: "{{ routerelbrec.set.alias_hosted_zone_id }}"
      when: routerelbrec.set is defined and "{} != routerelbrec.set" and routerelbrec.set.alias_hosted_zone_id is defined
      delegate_to: localhost
  roles:
    - role: ansible-role-ec2
      role_action: deprovision
      delegate_to: localhost
      run_once: yes